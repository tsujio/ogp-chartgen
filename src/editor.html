<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Chart Editor</title>

    <style>
      body {
          margin: 0;
          background: whitesmoke;
      }

      .container {
          background: whitesmoke;
          height: 100vh;
          max-width: 600px;
          margin: auto;
      }

      #textUrl {
          white-space: nowrap;
          overflow-x: scroll;
      }      

      textarea {
          width: 100%;
          height: 20rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div>
        <p>This chart's URL</p>
        <p id="textUrl"></p>
      </div>

      <input id="radioChartLine" type="radio" name="radioChart" value="line">
      <label for="radioChartLine">Line</label>
      <input id="radioChartTimeSeries" type="radio" name="radioChart" value="timeSeries">
      <label for="radioChartTimeSeries">Time Series</label>
      <input id="radioChartBar" type="radio" name="radioChart" value="bar">
      <label for="radioChartBar">Bar</label>
      <input id="radioChartPie" type="radio" name="radioChart" value="pie">
      <label for="radioChartPie">Pie</label>
      <input id="radioChartScatter" type="radio" name="radioChart" value="scatter">
      <label for="radioChartScatter">Scatter</label>
      <input id="radioChartHistogram" type="radio" name="radioChart" value="histogram">
      <label for="radioChartHistogram">Histogram</label>

      <div class="chart-parameter-container line">
        <br><label for="textboxLineChartTitle">Chart Title</label><input id="textboxLineChartTitle" type="text">
        <br><label for="textboxLineChartXLabel">X Label</label><input id="textboxLineChartXLabel" type="text">
        <br><label for="textboxLineChartYLabel">Y Label</label><input id="textboxLineChartYLabel" type="text">
      </div>

      <div class="chart-parameter-container timeSeries">
        <br><label for="textboxTimeSeriesChartTitle">Chart Title</label><input id="textboxTimeSeriesChartTitle" type="text">
        <br><label for="textboxTimeSeriesChartXLabel">X Label</label><input id="textboxTimeSeriesChartXLabel" type="text">
        <br><label for="textboxTimeSeriesChartYLabel">Y Label</label><input id="textboxTimeSeriesChartYLabel" type="text">
        <br><label for="radioTimeSeriesChartIntervalUnitYear"><input id="radioTimeSeriesChartIntervalUnitYear" type="radio" name="radioTimeSeriesChartIntervalUnit" value="year"> Year</label>
            <label for="radioTimeSeriesChartIntervalUnitMonth"><input id="radioTimeSeriesChartIntervalUnitMonth" type="radio" name="radioTimeSeriesChartIntervalUnit" value="month"> Month</label>
            <label for="radioTimeSeriesChartIntervalUnitWeek"><input id="radioTimeSeriesChartIntervalUnitWeek" type="radio" name="radioTimeSeriesChartIntervalUnit" value="week" checked> Week</label>
            <label for="radioTimeSeriesChartIntervalUnitDay"><input id="radioTimeSeriesChartIntervalUnitDay" type="radio" name="radioTimeSeriesChartIntervalUnit" value="day" checked> Day</label>
            <label for="radioTimeSeriesChartIntervalUnitHour"><input id="radioTimeSeriesChartIntervalUnitHour" type="radio" name="radioTimeSeriesChartIntervalUnit" value="hour"> Hour</label>
            <label for="radioTimeSeriesChartIntervalUnitMinute"><input id="radioTimeSeriesChartIntervalUnitMinute" type="radio" name="radioTimeSeriesChartIntervalUnit" value="minute"> Minute</label>
      </div>

      <div class="chart-parameter-container bar">
        <br><label for="textboxBarChartTitle">Chart Title</label><input id="textboxBarChartTitle" type="text">
        <br><label for="textboxBarChartXLabel">X Label</label><input id="textboxBarChartXLabel" type="text">
        <br><label for="textboxBarChartYLabel">Y Label</label><input id="textboxBarChartYLabel" type="text">
        <br><label for="radioBarChartGroupingStyleStacked"><input id="radioBarChartGroupingStyleStacked" type="radio" name="radioBarChartGroupingStyle" value="stacked" checked> Stacked</label>
            <label for="radioBarChartGroupingStyleGrouped"><input id="radioBarChartGroupingStyleGrouped" type="radio" name="radioBarChartGroupingStyle" value="grouped"> Grouped</label>
      </div>

      <div class="chart-parameter-container pie">
        <br><label for="textboxPieChartTitle">Chart Title</label><input id="textboxPieChartTitle" type="text">
      </div>

      <div class="chart-parameter-container scatter">
        <br><label for="textboxScatterChartTitle">Chart Title</label><input id="textboxScatterChartTitle" type="text">
        <br><label for="textboxScatterChartXLabel">X Label</label><input id="textboxScatterChartXLabel" type="text">
        <br><label for="textboxScatterChartYLabel">Y Label</label><input id="textboxScatterChartYLabel" type="text">
      </div>

      <div class="chart-parameter-container histogram">
        <br><label for="textboxHistogramChartTitle">Chart Title</label><input id="textboxHistogramChartTitle" type="text">
        <br><label for="textboxHistogramChartXLabel">X Label</label><input id="textboxHistogramChartXLabel" type="text">
        <br><label for="textboxHistogramChartYLabel">Y Label</label><input id="textboxHistogramChartYLabel" type="text">
        <br><label for="textboxHistogramChartBins">Bins</label><input id="textboxHistogramChartBins" type="number">
      </div>

      <div>
        <textarea id="textareaChartData"></textarea>
      </div>

      <div>
        <img id="imgChart" src="#" />
      </div>
    </div>

    <script>
window.onload = () => {
  const radioCharts = document.querySelectorAll("input[name='radioChart']")

  const chartParams = {
    line: {
      title: document.querySelector("#textboxLineChartTitle"),
      xLabel: document.querySelector("#textboxLineChartXLabel"),
      yLabel: document.querySelector("#textboxLineChartYLabel"),
    },
    timeSeries: {
      title: document.querySelector("#textboxTimeSeriesChartTitle"),
      xLabel: document.querySelector("#textboxTimeSeriesChartXLabel"),
      yLabel: document.querySelector("#textboxTimeSeriesChartYLabel"),
      intervalUnits: Array.from(document.querySelectorAll("input[name='radioTimeSeriesChartIntervalUnit']")),
    },
    bar: {
      title: document.querySelector("#textboxBarChartTitle"),
      xLabel: document.querySelector("#textboxBarChartXLabel"),
      yLabel: document.querySelector("#textboxBarChartYLabel"),
      groupingStyles: Array.from(document.querySelectorAll("input[name='radioBarChartGroupingStyle']")),
    },
    pie: {
      title: document.querySelector("#textboxPieChartTitle"),
    },
    scatter: {
      title: document.querySelector("#textboxScatterChartTitle"),
      xLabel: document.querySelector("#textboxScatterChartXLabel"),
      yLabel: document.querySelector("#textboxScatterChartYLabel"),
    },
    histogram: {
      title: document.querySelector("#textboxHistogramChartTitle"),
      xLabel: document.querySelector("#textboxHistogramChartXLabel"),
      yLabel: document.querySelector("#textboxHistogramChartYLabel"),
      bins: document.querySelector("#textboxHistogramChartBins"),
    },
  }

  const textareaChartData = document.querySelector("#textareaChartData")

  const imgChart = document.querySelector("#imgChart")
  const textUrl = document.querySelector("#textUrl")

  for (const radio of radioCharts) {
    radio.onchange = () => {
      for (const container of document.querySelectorAll(".chart-parameter-container")) {
        container.style.display = "none"
      }
      document.querySelector(`.chart-parameter-container.${radio.value}`).style.display = radio.checked ? "block" : "none"

      updateImage()
    }
  }

  const updateImage = () => {
    const parseData = delimiter => {
      const rows = textareaChartData.value.split("\n").filter(line => line.trim() !== "").map(line => line.split(delimiter))
      const data = rows[0].map((col, j) => ({
        label: col,
        data: rows.slice(1).map(row => row[j]).map(v => v === "" ? null : Number.isNaN(Number(v)) ? v : parseFloat(v)),
      }))
      return data
    }

    let data
    for (const delimiter of ["\t", ","]) {
      data = parseData(delimiter)
      if (data.length > 1) {
        break
      }
    }

    const flattenIfSingleItem = ary => ary.length > 1 ? ary : ary.flat()

    let src
    for (const radio of radioCharts) {
      if (radio.checked) {
        switch (radio.value) {
        case "line":
          {
            src = {
              line: {
                title: chartParams.line.title.value,
                xLabel: chartParams.line.xLabel.value,
                yLabel: chartParams.line.yLabel.value,
                x: data[0].data,
                y: flattenIfSingleItem(data.slice(1).map(d => data.length <= 2 ? d.data : d)),
              }
            }
          }
          break

        case "timeSeries":
          {
            const intervalUnit = chartParams.timeSeries.intervalUnits.filter(e => e.checked).map(e => e.value)[0]

            src = {
              timeSeries: {
                title: chartParams.timeSeries.title.value,
                xLabel: chartParams.timeSeries.xLabel.value,
                yLabel: chartParams.timeSeries.yLabel.value,
                x: data[0].data,
                y: flattenIfSingleItem(data.slice(1).map(d => data.length <= 2 ? d.data : d)),
                xInterval: {
                  unit: intervalUnit,
                },
              }
            }
          }
          break

        case "bar":
          {
            const groupingStyle = chartParams.bar.groupingStyles.filter(e => e.checked).map(e => e.value)[0]

            src = {
              bar: {
                title: chartParams.bar.title.value,
                xLabel: chartParams.bar.xLabel.value,
                yLabel: chartParams.bar.yLabel.value,
                x: data[0].data,
                y: flattenIfSingleItem(data.slice(1).map(d => data.length <= 2 ? d.data : d)),
                groupingStyle: groupingStyle,
              }
            }
          }
          break

        case "pie":
          {
            src = {
              pie: {
                title: chartParams.pie.title.value,
                data: data[0].data.map((v, i) => ({label: data[1].data[i], value: v})),
              }
            }
          }
          break

        case "scatter":
          {
            src = {
              scatter: {
                title: chartParams.scatter.title.value,
                xLabel: chartParams.scatter.xLabel.value,
                yLabel: chartParams.scatter.yLabel.value,
                data: (data.length > 2 ?
                       data[0].data.map((x, i) => ({position: [x, data[1].data[i]], label: data[2].data[i]})) :
                       data[0].data.map((x, i) => [x, data[1].data[i]])),
              }
            }
          }
          break

        case "histogram":
          {
            const bins = parseInt(chartParams.histogram.bins.value, 10)

            src = {
              histogram: {
                title: chartParams.histogram.title.value,
                xLabel: chartParams.histogram.xLabel.value,
                yLabel: chartParams.histogram.yLabel.value,
                data: data[0].data,
                bins: bins,
              }
            }
          }
          break
        }

        break
      }
    }

    if (src) {
      const srcValue = encodeURIComponent(JSON.stringify(src))
      imgChart.setAttribute("src", `${location.origin}/image?src=${srcValue}`)
      textUrl.innerText = `${location.origin}/ogp?src=${srcValue}`
    } else {
      imgChart.setAttribute("src", "#")
      textUrl.innerText = ""
    }
  }

  for (const chart in chartParams) {
    for (const k in chartParams[chart]) {
      if (!Array.isArray(chartParams[chart][k])) {
        chartParams[chart][k].onchange = updateImage
      } else {
        for (const e of chartParams[chart][k]) {
          e.onchange = updateImage
        }
      }
    }
  }

  textareaChartData.onchange = updateImage

  radioCharts[0].click()
}
    </script>
  </body>
</html>
